{% extends "base.html" %}

{% block title %}Статус оплаты — Купи слона{% endblock %}

{% block content %}
<div class="mx-auto max-w-lg px-4 py-16 sm:px-6 lg:px-8" x-data="paymentReturn()" x-init="startPolling()">
    <div class="rounded-2xl border border-gray-200 bg-white p-8 text-center shadow-sm">

        <!-- Pending / waiting for webhook -->
        <template x-if="status === 'pending'">
            <div>
                <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-yellow-100">
                    <svg class="h-8 w-8 animate-spin text-yellow-600" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                </div>
                <h1 class="mb-2 text-2xl font-bold text-gray-900">Ожидаем подтверждения</h1>
                <p class="text-gray-600">Платёж обрабатывается. Это может занять несколько секунд...</p>
            </div>
        </template>

        <!-- Paid / processing / completed -->
        <template x-if="status === 'paid' || status === 'processing' || status === 'completed'">
            <div>
                <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-green-100">
                    <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <h1 class="mb-2 text-2xl font-bold text-gray-900">Оплата прошла успешно!</h1>
                <p class="mb-6 text-gray-600">Ваш слон уже генерируется. Перенаправляем в личный кабинет...</p>
                <a href="/dashboard/" class="inline-block rounded-lg bg-indigo-600 px-6 py-3 text-sm font-medium text-white hover:bg-indigo-700">
                    Перейти в кабинет
                </a>
            </div>
        </template>

        <!-- Cancelled -->
        <template x-if="status === 'cancelled'">
            <div>
                <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-red-100">
                    <svg class="h-8 w-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </div>
                <h1 class="mb-2 text-2xl font-bold text-gray-900">Оплата отменена</h1>
                <p class="mb-6 text-gray-600">Вы можете попробовать снова на главной странице.</p>
                <a href="/" class="inline-block rounded-lg bg-indigo-600 px-6 py-3 text-sm font-medium text-white hover:bg-indigo-700">
                    На главную
                </a>
            </div>
        </template>

        <!-- Failed -->
        <template x-if="status === 'failed'">
            <div>
                <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-red-100">
                    <svg class="h-8 w-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M12 3a9 9 0 100 18 9 9 0 000-18z"/>
                    </svg>
                </div>
                <h1 class="mb-2 text-2xl font-bold text-gray-900">Ошибка</h1>
                <p class="mb-6 text-gray-600">Что-то пошло не так. Попробуйте снова.</p>
                <a href="/" class="inline-block rounded-lg bg-indigo-600 px-6 py-3 text-sm font-medium text-white hover:bg-indigo-700">
                    На главную
                </a>
            </div>
        </template>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script type="module">
    import { ordersAPI } from '/static/js/api.js';

    window.paymentReturn = function() {
        return {
            status: '{{ order.status }}',
            orderId: {{ order.id }},
            pollCount: 0,
            maxPolls: 60,
            timer: null,

            startPolling() {
                if (this.status === 'paid' || this.status === 'processing' || this.status === 'completed') {
                    setTimeout(() => window.location.href = '/dashboard/', 3000);
                    return;
                }

                if (this.status !== 'pending') return;

                this.timer = setInterval(async () => {
                    this.pollCount++;
                    if (this.pollCount >= this.maxPolls) {
                        clearInterval(this.timer);
                        return;
                    }

                    try {
                        const order = await ordersAPI.get(this.orderId);
                        if (order.status !== this.status) {
                            this.status = order.status;
                            clearInterval(this.timer);
                            if (order.status === 'paid' || order.status === 'processing' || order.status === 'completed') {
                                setTimeout(() => window.location.href = '/dashboard/', 3000);
                            }
                        }
                    } catch (e) {
                        console.error('Poll error:', e);
                    }
                }, 3000);
            }
        };
    };
</script>
{% endblock %}
