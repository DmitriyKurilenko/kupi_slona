version: '3.9'

# Пример множества приложений на субдоменах с Traefik
# Требуется: wildcard DNS (* → IP) или отдельные A records

services:
  # ============================================
  # Приложение 1: Kupi Slona (slon.prvms.ru)
  # ============================================
  kupi_slona_db:
    image: postgres:16-alpine
    container_name: kupi_slona_db
    volumes:
      - kupi_slona_postgres:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=elephant_shop
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    networks:
      - kupi_slona_backend

  kupi_slona_redis:
    image: redis:7-alpine
    container_name: kupi_slona_redis
    networks:
      - kupi_slona_backend

  kupi_slona_web:
    build: .
    container_name: kupi_slona_web
    command: gunicorn config.wsgi:application --bind 0.0.0.0:8000
    volumes:
      - kupi_slona_static:/app/staticfiles
      - kupi_slona_media:/app/media
    env_file:
      - .env
    depends_on:
      - kupi_slona_db
      - kupi_slona_redis
    networks:
      - kupi_slona_backend
      - traefik-public
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"

      # slon.prvms.ru
      - "traefik.http.routers.kupi-slona.rule=Host(`slon.prvms.ru`)"
      - "traefik.http.routers.kupi-slona.entrypoints=websecure"
      - "traefik.http.routers.kupi-slona.tls.certresolver=letsencrypt"
      - "traefik.http.services.kupi-slona.loadbalancer.server.port=8000"

  # ============================================
  # Приложение 2: WordPress Blog (blog.prvms.ru)
  # ============================================
  blog_db:
    image: mysql:8.0
    container_name: blog_db
    volumes:
      - blog_mysql:/var/lib/mysql
    environment:
      - MYSQL_DATABASE=wordpress
      - MYSQL_USER=wordpress
      - MYSQL_PASSWORD=wordpress_pass
      - MYSQL_ROOT_PASSWORD=root_pass
    networks:
      - blog_backend

  blog_wordpress:
    image: wordpress:latest
    container_name: blog_wordpress
    volumes:
      - blog_data:/var/www/html
    environment:
      - WORDPRESS_DB_HOST=blog_db
      - WORDPRESS_DB_NAME=wordpress
      - WORDPRESS_DB_USER=wordpress
      - WORDPRESS_DB_PASSWORD=wordpress_pass
    depends_on:
      - blog_db
    networks:
      - blog_backend
      - traefik-public
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"

      # blog.prvms.ru
      - "traefik.http.routers.blog.rule=Host(`blog.prvms.ru`)"
      - "traefik.http.routers.blog.entrypoints=websecure"
      - "traefik.http.routers.blog.tls.certresolver=letsencrypt"
      - "traefik.http.services.blog.loadbalancer.server.port=80"

  # ============================================
  # Приложение 3: Adminer DB Admin (db.prvms.ru)
  # ============================================
  adminer:
    image: adminer:latest
    container_name: adminer
    networks:
      - traefik-public
      - kupi_slona_backend
      - blog_backend
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"

      # db.prvms.ru
      - "traefik.http.routers.adminer.rule=Host(`db.prvms.ru`)"
      - "traefik.http.routers.adminer.entrypoints=websecure"
      - "traefik.http.routers.adminer.tls.certresolver=letsencrypt"
      - "traefik.http.services.adminer.loadbalancer.server.port=8080"

      # Basic Auth для безопасности
      - "traefik.http.routers.adminer.middlewares=adminer-auth"
      - "traefik.http.middlewares.adminer-auth.basicauth.users=admin:$$apr1$$8EVjn/nj$$GiLUZqcbueTFeD23SuB6x0"

  # ============================================
  # Приложение 4: Uptime Kuma (status.prvms.ru)
  # ============================================
  uptime_kuma:
    image: louislam/uptime-kuma:latest
    container_name: uptime_kuma
    volumes:
      - uptime_kuma_data:/app/data
    networks:
      - traefik-public
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"

      # status.prvms.ru
      - "traefik.http.routers.status.rule=Host(`status.prvms.ru`)"
      - "traefik.http.routers.status.entrypoints=websecure"
      - "traefik.http.routers.status.tls.certresolver=letsencrypt"
      - "traefik.http.services.status.loadbalancer.server.port=3001"

  # ============================================
  # Приложение 5: Portainer (docker.prvms.ru)
  # ============================================
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - traefik-public
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"

      # docker.prvms.ru
      - "traefik.http.routers.portainer.rule=Host(`docker.prvms.ru`)"
      - "traefik.http.routers.portainer.entrypoints=websecure"
      - "traefik.http.routers.portainer.tls.certresolver=letsencrypt"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"

volumes:
  kupi_slona_postgres:
  kupi_slona_static:
  kupi_slona_media:
  blog_mysql:
  blog_data:
  uptime_kuma_data:
  portainer_data:

networks:
  kupi_slona_backend:
  blog_backend:
  traefik-public:
    external: true  # Создана Traefik
